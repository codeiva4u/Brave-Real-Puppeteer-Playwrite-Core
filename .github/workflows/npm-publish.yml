name: ğŸ¦ Brave NPM Auto-Publish

on:
  workflow_dispatch:   # manually à¤­à¥€ à¤šà¤²à¤¾ à¤¸à¤•à¤¤à¥‡ à¤¹à¥‹
  push:
    branches: [ main ] # main branch à¤ªà¤° push à¤¹à¥‹à¤¨à¥‡ à¤ªà¤° run
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'

jobs:
  auto-version-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'

      - name: ğŸ“¦ Install Dependencies
        run: npm install

      # ğŸ†• Auto bump patch version + create git tag
      - name: ğŸ”§ Bump Version and Create Git Tag
        id: version
        uses: phips28/gh-action-bump-version@master
        with:
          tag-prefix: "v"       # tag à¤¬à¤¨à¥‡à¤—à¤¾ v1.0.1 à¤œà¥ˆà¤¸à¤¾
          default: patch        # à¤¹à¤®à¥‡à¤¶à¤¾ patch bump à¤¹à¥‹à¤—à¤¾
          commit-message: "ğŸ”– release: {version}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ­ Run Comprehensive Setup & Testing
        run: |
          npm run version-sync
          npm run setup-both-basic
          npm run create-brave-packages
          npm run ai-agent

      - name: ğŸ§ª Bot Detection Test (Headless)
        run: npm run test-bot-detector-headless || echo "âš ï¸ Bot detection test completed with warnings"

      - name: ğŸš€ Publish to NPM
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ğŸ‰ Success Summary
        run: |
          echo "ğŸ‰ WORKFLOW COMPLETED SUCCESSFULLY!"
          echo "ğŸ“¦ Package: brave-real-puppeteer-playwright-core"
          echo "ğŸ·ï¸ Tag: v${{ steps.version.outputs.newTag }}"
          echo "ğŸ”– Version: ${{ steps.version.outputs.newVersion }}"
          echo "ğŸš€ Published to NPM"
