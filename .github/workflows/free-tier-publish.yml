# ğŸ†“ Free Tier NPM Publish - Manual Trigger Workflow
# Perfect for testing and manual publishing without complex automation

name: Free Tier NPM Publish

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'ğŸ§ª Test mode (dry run without actual publish)'
        required: true
        default: 'true'
        type: boolean
      version_bump:
        description: 'ğŸ“ˆ Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor  
          - major
          - brave-timestamp
      skip_tests:
        description: 'âš¡ Skip tests for faster execution'
        required: false
        default: 'false'
        type: boolean

jobs:
  free-tier-publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm install --prefer-offline --no-audit
          
      - name: ğŸ”§ Generate New Version
        id: version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          
          if [ "${{ inputs.version_bump }}" = "brave-timestamp" ]; then
            # Generate brave timestamp version
            TIMESTAMP=$(date -u +"%Y.%m.%d.%H%M")
            BASE_VERSION=$(echo $CURRENT_VERSION | cut -d'-' -f1)
            NEW_VERSION="${BASE_VERSION}-brave.${TIMESTAMP}"
            
            # Add random suffix if version exists
            if npm view brave-real-puppeteer-playwright-core@${NEW_VERSION} version 2>/dev/null; then
              RANDOM=$((RANDOM % 99))
              NEW_VERSION="${BASE_VERSION}-brave.${TIMESTAMP}.${RANDOM}"
            fi
          else
            # Standard npm version bump
            NEW_VERSION=$(npm version ${{ inputs.version_bump }} --no-git-tag-version --dry-run | sed 's/^v//')
            npm version ${{ inputs.version_bump }} --no-git-tag-version
          fi
          
          echo "ğŸ¯ New version: ${NEW_VERSION}"
          echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "current_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
      
      - name: ğŸ“ Update Package.json (Brave Timestamp)
        if: ${{ inputs.version_bump == 'brave-timestamp' }}
        run: |
          npm version ${{ steps.version.outputs.new_version }} --no-git-tag-version
          echo "âœ… Updated to ${{ steps.version.outputs.new_version }}"
      
      - name: ğŸ­ Quick Setup (Essential Only)
        if: ${{ inputs.skip_tests != 'true' }}
        run: |
          echo "ğŸ” Version sync..."
          npm run version-sync || echo "âš ï¸ Version sync warning"
          
          echo "ğŸ­ Basic patching..."
          npm run patch-puppeteer-basic || echo "âš ï¸ Puppeteer patch warning"
          npm run patch-playwright-basic || echo "âš ï¸ Playwright patch warning"
          
          echo "ğŸ¦ Creating packages..."
          npm run create-brave-packages || echo "âš ï¸ Package creation warning"
      
      - name: âš¡ Quick Mode (Skip Tests)
        if: ${{ inputs.skip_tests == 'true' }}
        run: |
          echo "âš¡ QUICK MODE - Skipping comprehensive tests"
          echo "ğŸ“¦ Package ready for publish"
      
      - name: ğŸ“Š Package Summary
        run: |
          echo "ğŸ“Š PACKAGE SUMMARY"
          echo "=================="
          echo "ğŸ“¦ Name: $(node -p "require('./package.json').name")"
          echo "ğŸ”– Old Version: ${{ steps.version.outputs.current_version }}"
          echo "ğŸ†• New Version: ${{ steps.version.outputs.new_version }}"
          echo "ğŸ¯ Bump Type: ${{ inputs.version_bump }}"
          echo "ğŸ§ª Test Mode: ${{ inputs.test_mode }}"
          echo "âš¡ Skip Tests: ${{ inputs.skip_tests }}"
          
          echo ""
          echo "ğŸ“ Files included:"
          echo "$(node -p "require('./package.json').files?.join(', ') || 'All files'")"
      
      - name: ğŸ§ª Test Mode Output
        if: ${{ inputs.test_mode == 'true' }}
        run: |
          echo "ğŸ§ª TEST MODE - DRY RUN"
          echo "======================"
          echo "âœ… Would publish: brave-real-puppeteer-playwright-core@${{ steps.version.outputs.new_version }}"
          echo "ğŸ“¦ Package is ready for production publish"
          echo "ğŸ”„ To publish for real, set test_mode to 'false'"
      
      - name: ğŸš€ Publish to NPM (Production)
        if: ${{ inputs.test_mode != 'true' }}
        run: |
          echo "ğŸš€ Publishing to NPM..."
          npm publish
          echo "âœ… Published: brave-real-puppeteer-playwright-core@${{ steps.version.outputs.new_version }}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: ğŸ·ï¸ Create Git Tag (Production Only)
        if: ${{ inputs.test_mode != 'true' }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          TAG_NAME="v${{ steps.version.outputs.new_version }}"
          
          git tag -a "$TAG_NAME" -m "ğŸ†“ Free Tier Release ${{ steps.version.outputs.new_version }}

          ğŸ¯ Version Bump: ${{ inputs.version_bump }}
          âš¡ Quick Mode: ${{ inputs.skip_tests }}
          
          âœ… Features:
          - Brave stealth integration
          - Cross-platform support
          - Professional automation
          
          ğŸ†“ Published via Free Tier workflow"
          
          git push origin "$TAG_NAME"
          echo "âœ… Tagged: $TAG_NAME"
      
      - name: ğŸ‰ Success Message
        run: |
          echo ""
          echo "ğŸ‰ FREE TIER WORKFLOW COMPLETED!"
          echo "================================"
          
          if [ "${{ inputs.test_mode }}" = "true" ]; then
            echo "ğŸ§ª TEST MODE - Dry run successful"
            echo "ğŸ”„ Ready for production publish"
          else
            echo "ğŸš€ PRODUCTION - Successfully published!"
            echo "ğŸ“¦ NPM: https://www.npmjs.com/package/brave-real-puppeteer-playwright-core"
            echo "ğŸ’¾ Install: npm install brave-real-puppeteer-playwright-core@${{ steps.version.outputs.new_version }}"
          fi
          
          echo ""
          echo "ğŸ“Š Summary:"
          echo "- Version: ${{ steps.version.outputs.new_version }}"
          echo "- Bump: ${{ inputs.version_bump }}"
          echo "- Tests: ${{ inputs.skip_tests == 'true' && 'Skipped' || 'Included' }}"
          echo "- Mode: ${{ inputs.test_mode == 'true' && 'Test' || 'Production' }}"